<html>
<head>
    <title>Ouija | Slave failures</title>
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    <script src="/js/sorttable.js"></script>
    <script type="text/javascript">
        var req = new XMLHttpRequest();
        req.onload = function(e) {
            var raw_data = JSON.parse(req.response);
            var slaves_data = raw_data[0];
            var dates = raw_data[1];

            // insert dates
            document.getElementById('startDate').innerHTML = dates.startDate;
            document.getElementById('endDate').innerHTML = dates.endDate;

            // default soring by total runs desc
            var to_sort = [];
            for (var item in slaves_data) {
                to_sort.push({key: item, value: slaves_data[item].total});
            }
            to_sort.sort(function(x, y) {return y.value - x.value});

            // populate results table
            var tbl = document.getElementById('results');
            for (var i=0; i<to_sort.length; i++) {
                var slave = to_sort[i].key;
                var results = slaves_data[slave];
                results['slave'] = slave;

                var row = tbl.insertRow(-1);

                var labels = getTableColumns();
                for (var j=0; j<labels.length; j++) {
                    row.insertCell(-1).innerHTML = results[labels[j]];
                }

                // hide rows with no failures and retries
                if (results.success == results.total) {
                    row.className = 'hidden';
                }
            }

            // make table sortable
            sorttable.makeSortable(tbl);

        }

        req.open('get', '/data/slaves', true);
        req.send();

        function showHidden() {
            var hiddenRows = document.getElementsByClassName('hidden');
            var isChecked = document.getElementById('showHidden').checked;
            var styleValue = isChecked == true ? 'table-row' : 'none';

            for (var i=0; i<hiddenRows.length; i++) {
                hiddenRows[i].style.display = styleValue;
            }
        }

        function getTableColumns() {
            var columns = new Array();
            var firstRow = document.getElementById('results').rows[0];
            for (var i=0; i<firstRow.cells.length; i++) {
                columns.push(firstRow.cells[i].dataset['type']);
            }
            return columns;
        }
    </script>
</head>
<body>
    <div id="page_header">
        <h1>Slaves</h1>
    </div>
    <p>
        <strong>Results displayed for:</strong>
        <span id="startDate"></span> &mdash; <span id="endDate"></span>
    </p>
    <p>By default slaves that have no failures or retries are not shown</br>
        Toggle checkbox to see results for all slaves
    </p>
    <input type="checkbox" id="showHidden" onclick="showHidden()">Display all slaves
    </br></br>
    <table id="results">
        <tr>
            <td data-type="slave">Slave</td>
            <td data-type="fail">Fails</td>
            <td data-type="retry">Retries</td>
            <td data-type="success">Passes</td>
            <td data-type="total">Total</td>
        </tr>
    </table>
</body>
</html>
