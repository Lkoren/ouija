<html>
<head>
    <title>Ouija | Slave failures</title>
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    <script src="/js/sorttable.js"></script>
    <script type="text/javascript">
        var req = new XMLHttpRequest();
        req.onload = function(e) {
            var raw_data = JSON.parse(req.response);
            var slaves_data = raw_data[0];
            var platform_data = raw_data[1];
            var dates = raw_data[2];

            // insert dates
            document.getElementById('startDate').innerHTML = dates.startDate;
            document.getElementById('endDate').innerHTML = dates.endDate;

            // default soring by total runs desc
            var to_sort = [];
            for (var item in slaves_data) {
                to_sort.push({key: item, value: slaves_data[item].total});
            }
            to_sort.sort(function(x, y) {return y.value - x.value});

            // populate results table
            var tbl = document.getElementById('results');
            for (var i=0; i<to_sort.length; i++) {
                var slave = to_sort[i].key;
                var results = slaves_data[slave];
                results['slave'] = slave;

                // get platform failure rate
                for (var item in platform_data) {
                    var re = RegExp("^" + item + "-.*");
                    if (results['slave'].match(re) != null) {
                        var failRates = platform_data[item];
                        results['pFailRate'] = failRates['failRate'];
                        results['pFailRateNoRetries'] = failRates['failRateNoRetries'];
                    }
                }

                var row = tbl.insertRow(-1);

                // hide rows with no failures and retries
                if (results.success == results.total) {
                    row.className = 'hidden';
                }

                var labels = getTableColumns();
                for (var j=0; j<labels.length; j++) {
                    var cell = row.insertCell(-1);

                    if (labels[j] == 'sfr') {
                        cell.dataset['withRetries'] = results['failRate'];
                        cell.dataset['noRetries'] = results['failRateNoRetries'];
                    } else if (labels[j] == 'pfr') {
                        cell.dataset['withRetries'] = results['pFailRate'];
                        cell.dataset['noRetries'] = results['pFailRateNoRetries'];
                    } else {
                        cell.innerHTML = results[labels[j]];
                    }
                }
            }

            // populate sfr and pfr columns
            switchFailRates();
            // make table sortable
            sorttable.makeSortable(tbl);

        }

        req.open('get', '/data/slaves', true);
        req.send();

        function switchFailRates() {
            var isChecked = document.getElementById('includeRetries').checked;
            var attrToUse = isChecked == true ? 'withRetries' : 'noRetries';

            var tblRows = document.getElementById('results').rows;
            var labels = getTableColumns();
            var sfrIndex = labels.indexOf('sfr');
            var pfrIndex = labels.indexOf('pfr');

            for (var i=1; i<tblRows.length; i++) {
                var sfrCell = tblRows[i].cells[sfrIndex];
                var sfr = sfrCell.dataset[attrToUse];
                sfrCell.innerHTML = sfr;

                var pfrCell = tblRows[i].cells[pfrIndex];
                var pfr = pfrCell.dataset[attrToUse];
                pfrCell.innerHTML = pfr;

                if (parseFloat(sfr) > parseFloat(pfr)) {
                    sfrCell.className = 'alert';
                } else {
                    sfrCell.removeAttribute('class');
                }
            }
        }

        function showHidden() {
            var hiddenRows = document.getElementsByClassName('hidden');
            var isChecked = document.getElementById('showHidden').checked;
            var styleValue = isChecked == true ? 'table-row' : 'none';

            for (var i=0; i<hiddenRows.length; i++) {
                hiddenRows[i].style.display = styleValue;
            }
        }

        function getTableColumns() {
            var columns = new Array();
            var firstRow = document.getElementById('results').rows[0];
            for (var i=0; i<firstRow.cells.length; i++) {
                columns.push(firstRow.cells[i].dataset['type']);
            }
            return columns;
        }
    </script>
</head>
<body>
    <div id="page_header">
        <h1>Slaves</h1>
    </div>
    <p>
        <strong>Results displayed for:</strong>
        <span id="startDate"></span> &mdash; <span id="endDate"></span>
    </p>
    <p>By default slaves that have no failures or retries are not shown</br>
        Toggle checkbox to see results for all slaves
    </p>
        <input type="checkbox" id="showHidden" onclick="showHidden()">
        <label for="showHidden">Display all slaves</label>
        <input type="checkbox" id="includeRetries" onclick="switchFailRates()">
        <label for="includeRetries">Include retries in FR calculation</label>
    </br></br>
    <table id="results">
        <tr>
            <td data-type="slave">Slave</td>
            <td data-type="fail">Fails</td>
            <td data-type="retry">Retries</td>
            <td data-type="infra">Infra</td>
            <td data-type="success">Passes</td>
            <td data-type="total">Total</td>
            <td data-type="sfr">% failure</td>
            <td data-type="pfr">Expected % failure</td>
        </tr>
    </table>
</body>
</html>
